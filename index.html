<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MC8R5PYYFB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MC8R5PYYFB');
</script>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <div style="text-align:center; margin-bottom:20px;">
    <img src="logo.png" alt="MicroHabit AI Logo" style="width:50px; height:50px; display:block; margin:0 auto 10px auto;">
</div>
    <!-- App Logo -->
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#4a90e2">
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"MicroHabit AI\",
        \"short_name\": \"MicroHabit\",
        \"display\": \"standalone\",
        \"background_color\": \"#ffffff\",
        \"theme_color\": \"#4a90e2\",
        \"icons\": [{ \"src\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\", \"sizes\": \"192x192\", \"type\": \"image/png\" }]
    }">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f0f4f8;
            --card: white;
            --text: #333;
            --nudge-bg: #e0f7fa;
        }
        body.dark {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #eee;
            --nudge-bg: #00363a;
        }
        body.premium {
            --primary: #ffd700; /* Gold */
        }
        body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); transition: background 0.3s; }
        h1 { text-align: center; color: var(--primary); }
        input[type="text"], input[type="password"], input[type="number"], select, input[type="file"] { width: 70%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 15px; font-size: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin: 5px 0; }
        ul { list-style: none; padding: 0; }
        li { background: var(--card); margin: 10px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .habit-header { display: flex; align-items: center; }
        .habit-emoji { font-size: 32px; margin-right: 10px; }
        .habit-name { font-weight: bold; font-size: 18px; }
        .premium-badge { background: gold; color: black; padding: 2px 8px; border-radius: 10px; font-size: 12px; align-self: flex-start; margin-top: 5px; }
        .streak { background: var(--primary); color: white; padding: 5px 10px; border-radius: 20px; font-size: 14px; align-self: flex-start; }
        .progress-container { margin: 10px 0; }
        .progress-text { font-size: 14px; margin-bottom: 5px; }
        progress { width: 100%; height: 20px; accent-color: var(--primary); }
        .checkbox { transform: scale(1.5); margin: 10px 10px 10px 0; }
        .habit-controls { display: flex; justify-content: space-between; align-items: center; }
        #nudge { margin-top: 20px; padding: 15px; background: var(--nudge-bg); border-radius: 8px; min-height: 50px; }
        #apiSection, #notifySection, #themeSection, #premiumSection, #dataSection, #calendarSection { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .theme-buttons button { background: #666; margin: 5px; }
        .color-buttons button { width: 40px; height: 40px; border-radius: 50%; margin: 5px; padding: 0; }
        #premiumSection { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #333; text-align: center; }
        #premiumSection button { background: #fff; color: #ff8c00; font-weight: bold; font-size: 20px; padding: 15px; width: 100%; }
        .api-note { font-size: 14px; margin: 10px 0; text-align: center; }
        footer { text-align: center; margin-top: 30px; font-size: 12px; color: #999; }
        #calendar { width: 100%; border-collapse: collapse; margin-top: 10px; }
        #calendar th, #calendar td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        #calendar th { background: var(--primary); color: white; }
        .day-complete { background: #28a745 !important; color: white; font-weight: bold; }
        .day-today { background: #ffd700; color: black; }

        /* Navigation Menu */
        #navMenu {
            display: flex;
            justify-content: space-around;
            background: var(--card);
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        #navMenu button {
            flex: 1;
            margin: 0 5px;
            padding: 12px 10px;
            font-size: 14px;
            background: transparent;
            color: var(--text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #navMenu button:hover {
            background: var(--primary);
            color: white;
        }
        #navMenu button.active {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Mobile responsive */
        @media (max-width: 600px) {
            #navMenu {
                flex-wrap: wrap;
            }
            #navMenu button {
                font-size: 12px;
                padding: 10px 5px;
            }
        }

        /* Onboarding Modal */
        #onboarding {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        #onboarding-content {
            background: var(--card);
            padding: 25px 20px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90vh;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow-y: auto;
            margin: auto;
        }
        #onboarding h2 { font-size: 24px; margin-bottom: 10px; margin-top: 0; }
        #onboarding p { font-size: 16px; margin: 8px 0; }
        #onboarding ol { text-align: left; font-size: 14px; margin: 15px auto; padding-left: 20px; max-width: 400px; }
        #onboarding ol li { margin: 8px 0; }
        #onboarding button { font-size: 18px; padding: 12px 30px; margin-top: 15px; }
    </style>
</head>
<body>
<div id="authSection">
  <h2 id="authTitle">Sign Up or Login</h2>
  <p>Use email to keep premium & habits on any device!</p>
  <input type="email" id="emailInput" placeholder="Your email">
  <input type="password" id="passwordInput" placeholder="Password (6+ chars)">
  <input type="password" id="confirmPasswordInput" placeholder="Confirm password" style="display:none;">
  <button onclick="signUp()" id="signupBtn">Sign Up (new)</button>
  <button onclick="login()" id="loginBtn">Login</button>
  <button onclick="showForgotPassword()" style="background:#666; font-size:14px;">Forgot Password?</button>
  <p id="authStatus" style="color: red;"></p>
</div>
    <!-- Onboarding Modal -->
    <div id="onboarding">
        <div id="onboarding-content">
            <h2>ğŸ¯ Welcome to MicroHabit AI Tracker!</h2>
            <p>Build better habits with predictive AI coaching worldwide! ğŸš€</p>
            <p>Track streaks, get smart nudges, and level up your life.</p>
            <ol>
                <li>Add your habits & goals below âœ…</li>
                <li>Check off daily for streaks ğŸ”¥</li>
                <li>Get free Gemini key for AI predictions (link in key section) ğŸ¤–</li>
                <li>Upgrade Premium for unlimited everything ($9/month) ğŸ’</li>
            </ol>
            <button onclick="closeOnboarding()">Get Started!</button>
        </div>
    </div>

    <h1>MicroHabit AI Tracker</h1>
    
    <div id="mainApp" style="display:none;">
    <div style="text-align:center; margin-bottom:20px;">
    <span id="userEmail"></span>
    <button onclick="logout()" style="background:#666;">Logout</button>
  </div>

  <!-- Navigation Menu -->
  <div id="navMenu">
    <button class="active" onclick="showTab('habits')">ğŸ  Habits</button>
    <button onclick="showTab('ai')">ğŸ¤– AI Coach</button>
    <button onclick="showTab('premium')">ğŸ’ Premium</button>
    <button onclick="showTab('support')">ğŸ’¬ Support</button>
    <button onclick="showTab('settings')">âš™ï¸ Settings</button>
    <button onclick="showTab('data')">ğŸ“Š Data</button>
  </div>

  <!-- Habits Tab -->
  <div id="habitsTab" class="tab-content active">
    <h2 style="text-align:center;">My Habits</h2>
    <div>
        <input type="text" id="emojiInput" placeholder="Emoji (optional, e.g. ğŸ’ª)">
        <input type="text" id="newHabit" placeholder="Habit name (e.g., Gym)">
        <input type="number" id="goalInput" min="1" max="7" placeholder="Goal: days/week (1-7, default 7)">
        <button onclick="addHabit()">Add Habit</button>
    </div>
    <ul id="habitsList"></ul>
    
    <button onclick="toggleCalendar()" style="width:100%; margin-top:20px; padding:15px; font-size:18px; background:#333;">ğŸ“… View Calendar History</button>
    
    <div id="calendarSection" style="display:none; margin-top:20px;">
        <h2>Habit History Calendar</h2>
        <select id="habitSelect" onchange="renderCalendar()"></select>
        <div style="display:flex; justify-content:space-between;">
            <button onclick="prevMonth()">&lt; Prev</button>
            <h3 id="monthYear"></h3>
            <button onclick="nextMonth()">Next &gt;</button>
        </div>
        <table id="calendar"></table>
        <button onclick="toggleCalendar()" style="width:100%; margin-top:20px;">Close Calendar</button>
    </div>
  </div>

  <!-- AI Coach Tab -->
  <div id="aiTab" class="tab-content">
    <h2 style="text-align:center;">ğŸ¤– AI Predictive Coach</h2>
    
    <div id="apiSection">
        <p><strong>Gemini API Key</strong>:</p>
        <div class="api-note">
            Free Gemini key needed for the AI magic (predictions & nudges) â€“ get one in 30 seconds! ğŸ<br>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary); font-weight: bold;">Click here to create free key</a>
        </div>
        <input type="password" id="apiKeyInput" placeholder="Paste your key here">
        <button onclick="saveApiKey()">Save Key</button>
        <p id="keyStatus" style="color: red;">No key saved yet â€“ add one for real AI predictions!</p>
    </div>

    <button onclick="getAINudge(true)" style="width:100%; margin-top:20px; padding:15px; font-size:18px;">ğŸ”® Get AI Predictive Nudge Now</button>
    <div id="nudge">Your personalized AI coaching will appear here.<br><br><small>(Add your free Gemini key above for AI predictions!)</small></div>

    <div id="notifySection" style="margin-top:20px;">
        <p><strong>Daily Nudges</strong>:</p>
        <button onclick="requestNotificationPermission()" style="background:#28a745;">Enable Morning Predictions</button>
        <p id="notifyStatus">Notifications off â€“ enable for daily AI coaching!</p>
    </div>
  </div>

  <!-- Premium Tab -->
  <div id="premiumTab" class="tab-content">
    <div id="premiumSection">
        <h2>âœ¨ Choose Your Plan</h2>
        
        <!-- Free Plan -->
        <div style="background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #ddd;">
            <h3 style="margin-top: 0;">ğŸ†“ Free Plan</h3>
            <p style="font-size: 24px; font-weight: bold; color: #808080;">$0/month</p>
            <ul style="text-align:left; font-size: 14px; color: #808080;">
                <li>âœ… Up to 3 habits</li>
                <li>âœ… Basic streak tracking</li>
                <li>âœ… Calendar history</li>
                <li>âœ… AI nudges (with your own API key)</li>
                <li>âœ… Cloud sync</li>
            </ul>
            <p style="font-size: 12px; color: #666;">Perfect for trying out MicroHabit AI</p>
        </div>

        <!-- Premium Plan -->
        <div style="background: linear-gradient(135deg, #ffd700, #ff8c00); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 3px solid #ff8c00; color: #333;">
            <h3 style="margin-top: 0; color: #333;">ğŸ’ Premium Plan</h3>
            <p style="font-size: 28px; font-weight: bold; color: #808080;">$9/month</p>
            <ul style="text-align:left; font-size: 14px; color: #808080;">
                <li>âœ… <strong>Unlimited habits</strong></li>
                <li>âœ… Priority AI predictions</li>
                <li>âœ… No API limits</li>
                <li>âœ… Exclusive gold theme</li>
                <li>âœ… Custom colors & themes</li>
                <li>âœ… Priority support (6 hour response)</li>
                <li>âœ… Referral rewards</li>
            </ul>
            <button onclick="subscribePremium()" style="width: 100%; background: #fff; color: #ff8c00; font-weight: bold; font-size: 18px; padding: 15px; margin-top: 10px;">
                Upgrade to Premium - $9/month
            </button>
        </div>

        <!-- VIP Plan -->
        <div style="background: linear-gradient(135deg, #000000, #434343); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 4px solid gold; color: #fff; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 10px; right: 10px; background: gold; color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px;">
                ğŸŒŸ MOST POPULAR
            </div>
            <h3 style="margin-top: 0; color: gold; font-size: 24px;">ğŸ‘‘ VIP Plan - Elite Habit Mastery</h3>
            <p style="font-size: 32px; font-weight: bold; color: gold;">$99/month</p>
            <p style="font-size: 14px; color: #ccc; margin-top: -10px;">or $999/year (Save $189!)</p>
            
            <p style="color: #fff; font-weight: bold; margin: 15px 0;">Everything in Premium PLUS:</p>
            
            <ul style="text-align:left; font-size: 15px; color: #ffd700;">
                <li>ğŸ¤– <strong>Advanced AI Coach</strong> - Custom coaching personality</li>
                <li>ğŸ“Š <strong>Habit Insights Dashboard</strong> - AI analyzes your patterns</li>
                <li>ğŸ¯ <strong>Predictive Analytics</strong> - 30/60/90 day forecasts</li>
                <li>ğŸ“¸ <strong>Photo Progress Tracking</strong> - Visual before/after</li>
                <li>ğŸ“ <strong>Habit Journal</strong> - Notes & reflections for each day</li>
                <li>â±ï¸ <strong>Time Tracking</strong> - See how long you spend on habits</li>
                <li>ğŸ˜Š <strong>Mood Tracking</strong> - Correlate habits with mood/energy</li>
                <li>ğŸ† <strong>VIP Community Access</strong> - Exclusive Discord/Slack</li>
                <li>ğŸ“ <strong>Monthly 1-on-1 Call</strong> - Personal strategy session</li>
                <li>âš¡ <strong>1-Hour Priority Support</strong> - Fastest response time</li>
                <li>ğŸ¨ <strong>Unlimited Custom Themes</strong> - Design your own</li>
                <li>ğŸš€ <strong>Early Access</strong> - Try new features first</li>
                <li>ğŸ“¥ <strong>Advanced Export</strong> - CSV, Excel, API access</li>
                <li>ğŸ“ <strong>Exclusive Content</strong> - Webinars, guides, templates</li>
                <li>ğŸ”§ <strong>Custom Feature Requests</strong> - Your ideas prioritized</li>
            </ul>
            
            <button onclick="subscribeVIP()" style="width: 100%; background: gold; color: black; font-weight: bold; font-size: 20px; padding: 18px; margin-top: 15px; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ‘‘ Upgrade to VIP - $99/month
            </button>
            <button onclick="subscribeVIPYearly()" style="width: 100%; background: transparent; color: gold; font-weight: bold; font-size: 16px; padding: 12px; margin-top: 10px; border: 2px solid gold; border-radius: 8px; cursor: pointer;">
                ğŸ’° Pay Yearly - $999/year (Save $189!)
            </button>
        </div>

        <p id="premiumStatus" style="text-align: center;"><small>Free mode: Limited to 3 habits</small></p>
    </div>

    <div id="referralSection" style="background: var(--card); padding: 15px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h2>ğŸ Refer Friends - Get Free Premium!</h2>
        <p><strong>Share your code & earn rewards:</strong></p>
        <ul style="text-align:left; display:inline-block; font-size:14px;">
            <li>ğŸ‰ You get: <strong>1 month FREE Premium</strong> per referral</li>
            <li>ğŸ They get: <strong>1 week FREE Premium trial</strong></li>
            <li>ğŸ’ Unlimited referrals = Unlimited free months!</li>
        </ul>
        
        <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="margin: 5px 0;"><strong>Your Referral Code:</strong></p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="referralCode" readonly style="flex: 1; background: white; color: #333; font-weight: bold; font-size: 18px; text-align: center; cursor: pointer;" onclick="copyReferralCode()">
                <button onclick="copyReferralCode()" style="background: #28a745;">ğŸ“‹ Copy</button>
            </div>
            <p style="margin: 10px 0 5px 0; font-size: 14px; color: #666;">Share this code with friends!</p>
        </div>

        <div style="background: var(--bg); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <p style="margin: 5px 0;"><strong>ğŸ Have a referral code?</strong></p>
            <input type="text" id="referralInput" placeholder="Enter friend's code here" style="width: 70%; margin: 5px 0;">
            <button onclick="applyReferralCode()" style="background: #9c27b6;">Redeem Code</button>
            <p id="referralStatus" style="margin: 10px 0; font-size: 14px;"></p>
        </div>

        <div style="text-align: center; margin-top: 15px;">
            <p><strong>ğŸ“Š Your Referral Stats:</strong></p>
            <p id="referralStats" style="font-size: 16px; margin: 10px 0;">Loading...</p>
        </div>

        <button onclick="shareReferralCode()" style="width: 100%; background: #ff6b6b; padding: 15px; font-size: 16px; margin-top: 10px;">ğŸ“± Share My Code</button>
    </div>
  </div>

  <!-- Support Tab -->
  <div id="supportTab" class="tab-content">
    <h2 style="text-align:center;">ğŸ’¬ Customer Support</h2>
    <p style="text-align:center; color: #666;">We're here to help! Choose how you'd like to reach us:</p>
    
    <div style="background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>ğŸ“§ Email Support</h3>
        <p>Send us an email and we'll respond within 24 hours (Premium users: within 6 hours)</p>
        <input type="text" id="supportName" placeholder="Your Name" style="width: 90%; margin: 5px 0;">
        <input type="email" id="supportEmail" placeholder="Your Email" style="width: 90%; margin: 5px 0;" value="">
        <select id="supportCategory" style="width: 90%; margin: 5px 0; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px;">
            <option value="">Select Issue Type</option>
            <option value="technical">ğŸ”§ Technical Issue</option>
            <option value="billing">ğŸ’³ Billing Question</option>
            <option value="feature">ğŸ’¡ Feature Request</option>
            <option value="premium">ğŸ’ Premium Support</option>
            <option value="other">ğŸ“ Other</option>
        </select>
        <textarea id="supportMessage" placeholder="Describe your issue or question..." style="width: 90%; height: 120px; margin: 5px 0; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; font-family: Arial, sans-serif;"></textarea>
        <button onclick="sendSupportEmail()" style="width: 100%; background: #4a90e2; padding: 15px; font-size: 16px; margin-top: 10px;">ğŸ“¨ Send Message</button>
        <p id="supportEmailStatus" style="margin: 10px 0; font-size: 14px;"></p>
    </div>

    <div style="background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>ğŸ’¬ Live Chat</h3>
        <p>Chat with our support team in real-time</p>
        <button onclick="openLiveChat()" style="width: 100%; background: #25D366; padding: 15px; font-size: 16px;">
            <span style="font-size: 20px;">ğŸ’¬</span> Start Live Chat
        </button>
    </div>

    <div style="background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>ğŸ“± WhatsApp Support</h3>
        <p>Message us on WhatsApp for quick assistance</p>
        <button onclick="openWhatsApp()" style="width: 100%; background: #25D366; padding: 15px; font-size: 16px;">
            <span style="font-size: 20px;">ğŸ“±</span> Chat on WhatsApp
        </button>
    </div>

    <div style="background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>ğŸ¦ Twitter/X Support</h3>
        <p>Tweet at us or send a DM for public/private support</p>
        <button onclick="openTwitter()" style="width: 100%; background: #1DA1F2; padding: 15px; font-size: 16px;">
            <span style="font-size: 20px;">ğŸ¦</span> Contact on Twitter/X
        </button>
    </div>

    <div style="background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>â“ FAQ - Common Questions</h3>
        <details style="margin: 10px 0; padding: 10px; background: var(--bg); border-radius: 5px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">How do I get my free Gemini API key?</summary>
            <p style="padding: 10px;">Visit <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>, sign in with your Google account, and click "Create API Key". It's completely free!</p>
        </details>
        <details style="margin: 10px 0; padding: 10px; background: var(--bg); border-radius: 5px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">How does the referral program work?</summary>
            <p style="padding: 10px;">Share your unique referral code with friends. When they sign up and use your code, you get 30 days of free Premium and they get 7 days free!</p>
        </details>
        <details style="margin: 10px 0; padding: 10px; background: var(--bg); border-radius: 5px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">Can I cancel my Premium subscription?</summary>
            <p style="padding: 10px;">Yes! Contact us via any support channel and we'll process your cancellation immediately. No questions asked.</p>
        </details>
        <details style="margin: 10px 0; padding: 10px; background: var(--bg); border-radius: 5px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">Is my data safe and private?</summary>
            <p style="padding: 10px;">Absolutely! All your data is encrypted and stored securely in Firebase. We never share your data with third parties.</p>
        </details>
        <details style="margin: 10px 0; padding: 10px; background: var(--bg); border-radius: 5px;">
            <summary style="cursor: pointer; font-weight: bold; padding: 5px;">What's your response time?</summary>
            <p style="padding: 10px;">Free users: Within 24 hours. Premium users: Within 6 hours. Live chat: Instant during business hours (9 AM - 6 PM WAT).</p>
        </details>
    </div>

    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; text-align: center;">
        <h3 style="color: white;">ğŸ’ Premium Support Benefits</h3>
        <ul style="text-align: left; display: inline-block;">
            <li>âš¡ Priority response (within 6 hours)</li>
            <li>ğŸ“ Phone support available</li>
            <li>ğŸ¯ Dedicated support agent</li>
            <li>ğŸš€ Early access to new features</li>
            <li>ğŸ’¬ 24/7 live chat access</li>
        </ul>
        <button onclick="showTab('premium')" style="background: white; color: #764ba2; width: 100%; padding: 15px; font-size: 16px; margin-top: 10px;">
            Upgrade to Premium
        </button>
    </div>
  </div>

  <!-- Settings Tab -->
  <div id="settingsTab" class="tab-content">
    <h2 style="text-align:center;">âš™ï¸ Settings</h2>
    
    <div id="themeSection">
        <h3>ğŸ¨ Appearance</h3>
        <p><strong>Mode:</strong></p>
        <div class="theme-buttons">
            <button onclick="setTheme('light')">Light â˜€ï¸</button>
            <button onclick="setTheme('dark')">Dark ğŸŒ™</button>
            <button onclick="setTheme('system')">System Auto</button>
        </div>
        <p><strong>Accent Color:</strong></p>
        <div class="color-buttons">
            <button style="background:#4a90e2" onclick="setColor('#4a90e2')"></button>
            <button style="background:#2ecc71" onclick="setColor('#2ecc71')"></button>
            <button style="background:#9b59b6" onclick="setColor('#9b59b6')"></button>
            <button style="background:#e67e22" onclick="setColor('#e67e22')"></button>
            <button style="background:#e91e63" onclick="setColor('#e91e63')"></button>
        </div>
    </div>
  </div>

  <!-- Data Tab -->
  <div id="dataTab" class="tab-content">
    <h2 style="text-align:center;">ğŸ“Š Data Management</h2>
    
    <div id="dataSection">
        <h3>Backup & Restore</h3>
        <button onclick="exportData()" style="background:#28a745; width:100%; padding:15px; font-size:16px;">ğŸ“¥ Export Backup (JSON)</button>
        <button onclick="document.getElementById('importFile').click()" style="background:#ff9800; width:100%; margin-top:10px; padding:15px; font-size:16px;">ğŸ“¤ Import Backup (JSON)</button>
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
        
        <h3 style="margin-top:30px;">Share Progress</h3>
        <button onclick="shareStreaks()" style="background:#9c27b6; width:100%; padding:15px; font-size:16px;">ğŸ“± Share Streaks Summary</button>
    </div>
  </div>
    
    </div>
    
    <footer>
  Made by Treaz in 2026 â€¢ Data saved on your phone
  <br><br>
  <a href='https://www.saashub.com/microhabit-ai?utm_source=badge&utm_campaign=badge&utm_content=microhabit-ai&badge_variant=color&badge_kind=approved' target='_blank'>
    <img src="https://cdn-b.saashub.com/img/badges/approved-color.png?v=1" alt="MicroHabit AI badge" style="max-width: 150px;"/>
  </a>
</footer>

    <script>
    const firebaseConfig = {
  apiKey: "AIzaSyCwY2ZE1hPWdzyVB3HP9bpqH7CAD-LS0uk",
  authDomain: "microhabitai.firebaseapp.com",
  projectId: "microhabitai",
  storageBucket: "microhabitai.firebasestorage.app",
  messagingSenderId: "1028976429458",
  appId: "1:1028976429458:web:426559270fd35c4b83594b"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
  .catch((err) => {
    if (err.code == 'failed-precondition') {
      console.log("Multiple tabs open - persistence only works in one tab");
    } else if (err.code == 'unimplemented') {
      console.log("Browser doesn't support offline persistence");
    }
  });

        // IMPORTANT: Initialize these as null/empty until user logs in
        let habits = [];
        let isPremium = false;
        let isVIP = false;
        let currentUser = null;
        
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        const apiKeyStatus = document.getElementById('keyStatus');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const notifyStatus = document.getElementById('notifyStatus');
        const premiumStatus = document.getElementById('premiumStatus');

        // Hardcoded Paystack live details
        const paystackKey = 'pk_live_1905354f34a361ec2add315c3acfd0661e66b237';
const planCode = 'PLN_huf26j1826z3omt'; // Premium plan (â‚¦12,600/month)
const vipMonthlyPlanCode = 'PLN_1whwk3kgfhp99yh'; // VIP Monthly (â‚¦138,600/month) - CREATE THIS IN PAYSTACK
const vipYearlyPlanCode = 'PLN_1rgkv075imctgwj'; // VIP Yearly (â‚¦1,396,900/year) - CREATE THIS IN PAYSTACK
// Initialize EmailJS
emailjs.init('UYfxqAPuhdMFu8WtM');

// Send VIP Welcome Email
function sendVIPEmail(userEmail, userName) {
  const params = {
    email: userEmail,
    to_name: userName,
    whatsapp: '+234 810 865 8629'
  };
  
  emailjs.send('service_a776ut9', 'template_hmu70th', params)
    .then(function() {
      console.log('âœ… VIP email sent successfully!');
    })
    .catch(function(error) {
      console.log('âŒ Email failed:', error);
    });
}

        // Generate unique referral code for user
        function generateReferralCode(email) {
            const hash = email.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const code = 'MH' + hash.toString(36).toUpperCase().slice(0, 6);
            return code;
        }

        // Load and display referral code
        async function loadReferralCode() {
            if (!currentUser) return;
            
            const code = generateReferralCode(currentUser.email);
            document.getElementById('referralCode').value = code;
            
            // Load referral stats from Firebase
            const docSnap = await db.collection("users").doc(currentUser.uid).get();
            if (docSnap.exists) {
                const data = docSnap.data();
                const referrals = data.referrals || [];
                const freeDaysEarned = referrals.length * 30; // 30 days per referral
                const premiumUntil = data.premiumUntil ? new Date(data.premiumUntil) : null;
                
                let statusText = `ğŸ‘¥ ${referrals.length} successful referrals`;
                if (freeDaysEarned > 0) {
                    statusText += ` | ğŸ‰ ${freeDaysEarned} free days earned!`;
                }
                if (premiumUntil && premiumUntil > new Date()) {
                    const daysLeft = Math.ceil((premiumUntil - new Date()) / (1000 * 60 * 60 * 24));
                    statusText += ` | â³ Premium active for ${daysLeft} more days`;
                }
                
                document.getElementById('referralStats').textContent = statusText;
            }
        }

        // Copy referral code to clipboard
        function copyReferralCode() {
            const codeInput = document.getElementById('referralCode');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999); // For mobile
            navigator.clipboard.writeText(codeInput.value);
            alert('âœ… Referral code copied! Share it with friends.');
        }

        // Share referral code
        function shareReferralCode() {
            const code = document.getElementById('referralCode').value;
            const shareText = `ğŸ Join me on MicroHabit AI Tracker and get 1 WEEK FREE PREMIUM!\n\nUse my code: ${code}\n\nBuild better habits with AI coaching ğŸš€\n\n#HabitTracker #ProductivityApp`;
            
            if (navigator.share) {
                navigator.share({ text: shareText });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('âœ… Referral message copied to clipboard! Paste it anywhere to share.');
            }
        }

        // Apply referral code (for new users)
        async function applyReferralCode() {
            if (!currentUser) {
                document.getElementById('referralStatus').textContent = 'âŒ Please login first';
                document.getElementById('referralStatus').style.color = 'red';
                return;
            }

            const inputCode = document.getElementById('referralInput').value.trim().toUpperCase();
            if (!inputCode) {
                document.getElementById('referralStatus').textContent = 'âŒ Please enter a code';
                document.getElementById('referralStatus').style.color = 'red';
                return;
            }

            // Security: Validate code format
            if (!/^MH[A-Z0-9]{1,6}$/.test(inputCode)) {
                document.getElementById('referralStatus').textContent = 'âŒ Invalid code format';
                document.getElementById('referralStatus').style.color = 'red';
                return;
            }

            const myCode = generateReferralCode(currentUser.email);
            if (inputCode === myCode) {
                document.getElementById('referralStatus').textContent = 'âŒ You cannot use your own code!';
                document.getElementById('referralStatus').style.color = 'red';
                return;
            }

            // Check if user already used a referral code
            const myDoc = await db.collection("users").doc(currentUser.uid).get();
            if (myDoc.exists && myDoc.data().usedReferralCode) {
                document.getElementById('referralStatus').textContent = 'âŒ You already used a referral code!';
                document.getElementById('referralStatus').style.color = 'red';
                return;
            }

            // Security: Rate limiting - check account age
            const accountAge = new Date() - currentUser.metadata.creationTime;
            const oneDay = 24 * 60 * 60 * 1000;
            if (accountAge < oneDay) {
                // New accounts must wait 24h to prevent spam
                const hoursLeft = Math.ceil((oneDay - accountAge) / (60 * 60 * 1000));
                document.getElementById('referralStatus').textContent = `â³ New accounts must wait ${hoursLeft}h before using referral codes (anti-spam)`;
                document.getElementById('referralStatus').style.color = 'orange';
                return;
            }

            // Find the referrer by searching all users
            const usersSnapshot = await db.collection("users").get();
            let referrerId = null;
            let referrerEmail = null;

            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                if (userData.email) {
                    const userCode = generateReferralCode(userData.email);
                    if (userCode === inputCode) {
                        referrerId = doc.id;
                        referrerEmail = userData.email;
                    }
                }
            });

            if (!referrerId) {
                document.getElementById('referralStatus').textContent = 'âŒ Invalid referral code';
                document.getElementById('referralStatus').style.color = 'red';
                return;
            }

            // Give new user 7 days free premium
            const newUserPremiumUntil = new Date();
            newUserPremiumUntil.setDate(newUserPremiumUntil.getDate() + 7);

            await db.collection("users").doc(currentUser.uid).set({
                usedReferralCode: inputCode,
                referredBy: referrerId,
                premiumUntil: newUserPremiumUntil.toISOString(),
                isPremium: true,
                referralAppliedAt: new Date().toISOString() // Security: Track when applied
            }, { merge: true });

            // Give referrer 30 days free premium
            const referrerDoc = await db.collection("users").doc(referrerId).get();
            const referrerData = referrerDoc.data() || {};
            const referrerPremiumUntil = referrerData.premiumUntil ? new Date(referrerData.premiumUntil) : new Date();
            
            // If their premium already expired, start from today
            if (referrerPremiumUntil < new Date()) {
                referrerPremiumUntil.setTime(new Date().getTime());
            }
            
            // Add 30 days
            referrerPremiumUntil.setDate(referrerPremiumUntil.getDate() + 30);

            const referrals = referrerData.referrals || [];
            
            // Security: Limit total referrals per user to 50 to prevent abuse
            if (referrals.length >= 50) {
                document.getElementById('referralStatus').textContent = 'âš ï¸ Referrer has reached maximum referrals';
                document.getElementById('referralStatus').style.color = 'orange';
                return;
            }
            
            referrals.push({
                userId: currentUser.uid,
                email: currentUser.email,
                date: new Date().toISOString()
            });

            await db.collection("users").doc(referrerId).set({
                referrals: referrals,
                premiumUntil: referrerPremiumUntil.toISOString(),
                isPremium: true
            }, { merge: true });

            // Update local state
            isPremium = true;
            
            document.getElementById('referralStatus').textContent = 'ğŸ‰ Success! You got 7 days FREE Premium!';
            document.getElementById('referralStatus').style.color = 'green';
            
            saveHabits();
            applyTheme();
            checkPremium();
            
            alert(`ğŸ‰ Congrats! You just unlocked 7 days of FREE Premium!\n\nYour friend also got 30 free days as a thank you!`);
        }

        // Onboarding
        function checkOnboarding() {
            if (localStorage.getItem('onboardingShown') !== 'true') {
                document.getElementById('onboarding').style.display = 'flex';
            }
        }

        function closeOnboarding() {
            localStorage.setItem('onboardingShown', 'true');
            document.getElementById('onboarding').style.display = 'none';
        }

        function checkPremium() {
            if (isVIP) {
                document.body.classList.add('premium');
                document.body.classList.add('vip');
                premiumStatus.innerHTML = '<strong style="color:gold;">ğŸ‘‘ VIP MEMBER - Elite Status Active! ğŸŒŸ</strong><br><small>Enjoy all premium features + exclusive VIP benefits</small>';
            } else if (isPremium) {
                document.body.classList.add('premium');
                document.body.classList.remove('vip');
                premiumStatus.innerHTML = '<strong style="color:gold;">âœ¨ Premium Unlocked! ğŸ’ Unlimited everything + exclusive gold theme</strong>';
            } else {
                document.body.classList.remove('premium');
                document.body.classList.remove('vip');
                premiumStatus.innerHTML = '<small>Free mode: Limited to 3 habits â€“ Upgrade for unlimited!</small>';
            }
        }

        // Check if premium expired (for referral-based premium)
        async function checkPremiumExpiration() {
            if (!currentUser) return;
            
            const docSnap = await db.collection("users").doc(currentUser.uid).get();
            if (docSnap.exists) {
                const data = docSnap.data();
                
                // Check if they have a premiumUntil date
                if (data.premiumUntil) {
                    const premiumUntil = new Date(data.premiumUntil);
                    const now = new Date();
                    
                    if (premiumUntil > now) {
                        // Still premium
                        isPremium = true;
                    } else {
                        // Premium expired - only if they don't have a paid subscription
                        if (!data.hasActiveSubscription) {
                            isPremium = false;
                            await db.collection("users").doc(currentUser.uid).set({
                                isPremium: false
                            }, { merge: true });
                        }
                    }
                }
            }
            
            applyTheme();
            checkPremium();
        }

        function suggestEmoji(name) {
            const lower = name.toLowerCase();
            if (lower.includes('gym') || lower.includes('exercise')) return 'ğŸ’ª';
            if (lower.includes('water') || lower.includes('drink')) return 'ğŸ’§';
            if (lower.includes('read') || lower.includes('book')) return 'ğŸ“š';
            if (lower.includes('meditate') || lower.includes('yoga')) return 'ğŸ§˜';
            if (lower.includes('walk') || lower.includes('run')) return 'ğŸƒ';
            if (lower.includes('sleep')) return 'ğŸ˜´';
            return 'â­';
        }

        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            const savedColor = localStorage.getItem('primaryColor') || '#4a90e2';
            document.documentElement.style.setProperty('--primary', isPremium ? '#ffd700' : savedColor);
            if (savedTheme === 'system') {
                document.body.classList.remove('dark');
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark');
            } else {
                document.body.classList.toggle('dark', savedTheme === 'dark');
            }
            checkPremium();
        }

        function setTheme(mode) {
            localStorage.setItem('theme', mode);
            applyTheme();
        }

        function setColor(color) {
            if (!isPremium) localStorage.setItem('primaryColor', color);
            applyTheme();
        }

  function subscribePremium() {
    if (!currentUser) {
        alert('âš ï¸ Please login first to subscribe to Premium!');
        return;
    }

    const email = currentUser.email;

    const handler = PaystackPop.setup({
        key: paystackKey,
        email: email,
        plan: planCode,
        callback: function(response) {
            alert('Subscription successful! ğŸš€ Premium unlocked.');
            
            isPremium = true;
            isVIP = false;

            db.collection("users").doc(currentUser.uid).set({
                isPremium: true,
                isVIP: false,
                planType: 'premium',
                hasActiveSubscription: true,
                premiumActivatedAt: new Date().toISOString(),
                paystackReference: response.reference
            }, { merge: true }).then(() => {
                console.log("Premium status saved to Firebase successfully!");
                saveHabits();
                applyTheme();
                renderHabits();
                checkPremium();
            }).catch(err => {
                console.error("Failed to save premium to Firebase:", err);
                alert("Warning: Premium activated but cloud sync failed. Contact support.");
            });
        }
    });
    handler.openIframe();
}

  function subscribeVIP() {
    if (!currentUser) {
        alert('âš ï¸ Please login first to subscribe to VIP!');
        return;
    }

    const handler = PaystackPop.setup({
        key: paystackKey,
        email: currentUser.email,
        plan: vipMonthlyPlanCode, // âœ… CHANGED: Use plan instead of amount
        callback: function(response) {
            alert('ğŸ‰ VIP Subscription successful! Welcome to Elite Status! ğŸ‘‘');
            
            isPremium = true;
            isVIP = true;
            sendVIPEmail(currentUser.email, currentUser.email.split('@')[0]);

            db.collection("users").doc(currentUser.uid).set({
                isPremium: true,
                isVIP: true,
                planType: 'vip_monthly',
                hasActiveSubscription: true,
                vipActivatedAt: new Date().toISOString(),
                paystackReference: response.reference
            }, { merge: true }).then(() => {
                console.log("VIP status saved to Firebase successfully!");
                saveHabits();
                applyTheme();
                renderHabits();
                checkPremium();
                
                alert('ğŸ‘‘ Welcome to VIP!\n\nâœ¨ You now have access to:\n- Unlimited habits\n- Advanced AI Coach\n- Priority support\n- Gold theme & custom colors\n- Exclusive VIP features\n\nCheck your email for details!');
            }).catch(err => {
                console.error("Failed to save VIP to Firebase:", err);
                alert("Warning: VIP activated but cloud sync failed. Contact support.");
            });
        }
    });
    handler.openIframe();
}

  function subscribeVIPYearly() {
    if (!currentUser) {
        alert('âš ï¸ Please login first to subscribe to VIP!');
        return;
    }

    const handler = PaystackPop.setup({
        key: paystackKey,
        email: currentUser.email,
        plan: vipYearlyPlanCode, // âœ… CHANGED: Use plan instead of amount
        callback: function(response) {
            alert('ğŸ‰ VIP Yearly Subscription successful! You saved $189! ğŸ‘‘');
            
            isPremium = true;
            isVIP = true;
            sendVIPEmail(currentUser.email, currentUser.email.split('@')[0]);

            db.collection("users").doc(currentUser.uid).set({
                isPremium: true,
                isVIP: true,
                planType: 'vip_yearly',
                hasActiveSubscription: true,
                vipActivatedAt: new Date().toISOString(),
                paystackReference: response.reference
            }, { merge: true }).then(() => {
                console.log("VIP Yearly status saved to Firebase successfully!");
                saveHabits();
                applyTheme();
                renderHabits();
                checkPremium();
                
                alert('ğŸ‘‘ Welcome to VIP Yearly!\n\nâœ¨ You saved $189 and unlocked:\n- Unlimited habits\n- Advanced AI Coach\n- Priority support\n- Gold theme & custom colors\n- Exclusive VIP features\n\nCheck your email for details!');
            }).catch(err => {
                console.error("Failed to save VIP to Firebase:", err);
                alert("Warning: VIP activated but cloud sync failed. Contact support.");
            });
        }
    });
    handler.openIframe();
}
        function saveHabits() {
    // Migrate old habits if needed
    habits.forEach(h => {
        if (!h.goal) h.goal = 7;
        if (!h.emoji) h.emoji = suggestEmoji(h.name);
    });

    // Save to Firebase if logged in
    if (currentUser) {
        db.collection("users").doc(currentUser.uid).set({
            habits: habits,
            isPremium: isPremium,
            geminiKey: localStorage.getItem('geminiKey') || '',
            lastUpdated: new Date().toISOString()
        }, { merge: true })
        .then(() => console.log("âœ… Cloud Sync Successful"))
        .catch(err => console.error("âŒ Cloud Sync Failed", err));
    }
    renderHabits();
}

        function loadApiKey() {
            const key = localStorage.getItem('geminiKey');
            if (key) {
                apiKeyInput.value = key;
                apiKeyStatus.textContent = 'âœ… Key saved! Ready for AI nudges.';
                apiKeyStatus.style.color = 'green';
            }
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiKey', key);
                apiKeyStatus.textContent = 'âœ… Key saved successfully!';
                apiKeyStatus.style.color = 'green';
                
                // Sync to Firebase
                if (currentUser) {
                    db.collection("users").doc(currentUser.uid).set({
                        geminiKey: key
                    }, { merge: true });
                }
            } else {
                apiKeyStatus.textContent = 'âŒ Please paste a valid key.';
                apiKeyStatus.style.color = 'red';
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(perm => {
                    if (perm === 'granted') {
                        notifyStatus.textContent = 'âœ… Daily nudges enabled! Open app daily for morning predictions.';
                        notifyStatus.style.color = 'green';
                        showDailyNudge();
                    } else {
                        notifyStatus.textContent = 'âŒ Permission deniedâ€”enable in browser settings.';
                    }
                });
            }
        }

        function checkNotificationStatus() {
            if (Notification.permission === 'granted') {
                notifyStatus.textContent = 'âœ… Daily nudges enabled!';
                notifyStatus.style.color = 'green';
            }
        }

        async function showDailyNudge() {
            const nudge = await getAINudge(false, true);
            if (nudge && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('MicroHabit AI Daily Nudge', { body: nudge.replace(/<br>/g, '\n').substring(0, 100) + '... Open app for full!' });
            }
        }

        function getToday() { return new Date().toISOString().slice(0, 10); }

        function getWeekStart() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - (day === 0 ? 6 : day - 1);
            const monday = new Date(today);
            monday.setDate(diff);
            return monday.toISOString().slice(0, 10);
        }

        function getWeeklyCompletions(dates) {
            const weekStart = getWeekStart();
            return dates.filter(d => d >= weekStart).length;
        }

        function calculateStreak(dates) {
            if (dates.length === 0) return 0;
            dates = [...new Set(dates)].sort().reverse();
            let streak = 0;
            let checkDate = new Date();
            let currentDateStr = getToday();
            while (true) {
                if (dates[streak] === currentDateStr) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                    currentDateStr = checkDate.toISOString().slice(0, 10);
                } else if (streak > 0) break;
                else break;
            }
            return streak;
        }

        function renderHabits() {
            const list = document.getElementById('habitsList');
            list.innerHTML = '';
            const today = getToday();
            if (habits.length === 0) {
                list.innerHTML = '<li style="text-align:center; color:#999;">No habits yetâ€”add one above!</li>';
                return;
            }
            habits.forEach((habit, index) => {
                const li = document.createElement('li');
                const doneToday = habit.dates.includes(today);
                const streak = calculateStreak(habit.dates);
                const weeklyDone = getWeeklyCompletions(habit.dates);
                const goal = habit.goal || 7;
                const emoji = habit.emoji || 'â­';

                li.innerHTML = `
                    <div class="habit-header">
                        <span class="habit-emoji">${emoji}</span>
                        <div class="habit-name">${habit.name}</div>
                    </div>
                    ${isVIP ? '<div class="premium-badge" style="background: gold; color: black;">ğŸ‘‘ VIP HABIT</div>' : isPremium ? '<div class="premium-badge">Premium User ğŸ’</div>' : ''}
                    <div class="streak">ğŸ”¥ Streak: ${streak} day${streak !== 1 ? 's' : ''}</div>
                    <div class="progress-container">
                        <div class="progress-text">This week: ${weeklyDone}/${goal} days 
                            <button onclick="editGoal(${index})" style="background:#666; font-size:12px; padding:5px;">Edit Goal</button>
                        </div>
                        <progress value="${weeklyDone}" max="${goal}"></progress>
                    </div>
                    <div class="habit-controls">
                        <input type="checkbox" class="checkbox" ${doneToday ? 'checked' : ''}>
                        ${isVIP ? '<button onclick="addHabitNote(' + index + ')" style="background:#4a90e2; font-size:12px; padding:5px;">ğŸ“ Add Note</button>' : ''}
                        <button onclick="deleteHabit(${index})" style="background:red;">Delete</button>
                    </div>
                `;

                const checkbox = li.querySelector('input[type="checkbox"]');
                checkbox.onchange = () => {
                    if (checkbox.checked && !doneToday) habit.dates.push(today);
                    else if (!checkbox.checked && doneToday) habit.dates = habit.dates.filter(d => d !== today);
                    saveHabits();
                    populateHabitSelect();
                };

                list.appendChild(li);
            });
            populateHabitSelect();
        }

        function addHabit() {
            if (!isPremium && !isVIP && habits.length >= 3) {
                alert('ğŸ”’ Free limit: 3 habits. Upgrade to Premium for unlimited!');
                return;
            }
            const emojiInput = document.getElementById('emojiInput');
            const nameInput = document.getElementById('newHabit');
            const goalInput = document.getElementById('goalInput');
            let emoji = emojiInput.value.trim();
            const name = nameInput.value.trim();
            const goal = parseInt(goalInput.value) || 7;
            
            // Security: Sanitize inputs to prevent XSS
            const sanitizedName = sanitizeInput(name);
            const sanitizedEmoji = sanitizeInput(emoji);
            
            if (sanitizedName && goal >= 1 && goal <= 7) {
                if (!sanitizedEmoji) emoji = suggestEmoji(sanitizedName);
                else emoji = sanitizedEmoji;
                
                // VIP users can add additional metadata
                const habitData = {
                    name: sanitizedName,
                    emoji: emoji,
                    dates: [],
                    goal: goal
                };
                
                if (isVIP) {
                    habitData.notes = []; // VIP: Habit journal
                    habitData.photoUrls = []; // VIP: Progress photos
                    habitData.timeTracking = []; // VIP: Time spent
                    habitData.moodTracking = []; // VIP: Mood correlation
                }
                
                habits.push(habitData);
                emojiInput.value = '';
                nameInput.value = '';
                goalInput.value = '';
                saveHabits();
            }
        }

        // Security: Input sanitization function
        function sanitizeInput(input) {
            if (!input) return '';
            // Remove HTML tags and dangerous characters
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML.substring(0, 100); // Limit length
        }

        function editGoal(index) {
            const newGoal = prompt("Set new goal (days per week, 1-7):", habits[index].goal);
            const parsed = parseInt(newGoal);
            if (parsed >= 1 && parsed <= 7) {
                habits[index].goal = parsed;
                saveHabits();
            }
        }

        function deleteHabit(index) {
            if (confirm('Delete this habit? This cannot be undone.')) {
                habits.splice(index, 1);
                saveHabits();
            }
        }

        // VIP Feature: Add habit note
        function addHabitNote(index) {
            if (!isVIP) {
                alert('ğŸ“ Habit Journal is a VIP-only feature!\n\nUpgrade to VIP to unlock daily notes for each habit.');
                return;
            }
            
            const note = prompt(`Add a note for ${habits[index].name} today:`, '');
            if (note) {
                const today = getToday();
                if (!habits[index].notes) habits[index].notes = [];
                habits[index].notes.push({
                    date: today,
                    note: sanitizeInput(note)
                });
                saveHabits();
                alert('âœ… Note saved!');
            }
        }

        async function getAINudge(showInApp = true, silent = false) {
            const nudgeDiv = document.getElementById('nudge');
            const key = localStorage.getItem('geminiKey');
            if (!key) {
                const msg = 'ğŸ”‘ Add your free Gemini key above for AI predictions & nudges! âœ¨<br><br>Get one in 30 seconds: <a href="https://aistudio.google.com/app/apikey" target="_blank">Click here</a>';
                if (showInApp) nudgeDiv.innerHTML = msg;
                return msg;
            }

            if (showInApp) nudgeDiv.innerHTML = 'ğŸ¤– AI analyzing... (5-15 sec)';

            const today = getToday();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().slice(0, 10);

            const habitSummary = habits.length > 0 ? habits.map(h => {
                const streak = calculateStreak(h.dates);
                const weekly = getWeeklyCompletions(h.dates);
                return `- ${h.emoji || 'â­'} ${h.name}: Goal ${h.goal} days/week, this week ${weekly}/${h.goal}, streak ${streak} days`;
            }).join('\n') : 'No habits yet.';

            const prompt = `Predictive micro-habit coach.\n\nHabits:\n${habitSummary}\n\nToday: ${today}.\n\nFor tomorrow (${tomorrowStr}): Predict % skip chance per habit. If >60% or behind on weekly goal, give ONE fun, encouraging nudge.\nPositive vibe! Include emojis. Bold habit names. Start with "Alright, let's get you set for tomorrow, ${tomorrowStr}!"`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                if (showInApp) nudgeDiv.innerHTML = aiText.replace(/\n/g, '<br>');
                if (silent) return aiText;
                return aiText;
            } catch (e) {
                const msg = `âŒ Error: Check internet/key. Try again.`;
                if (showInApp) nudgeDiv.innerHTML = msg;
                return msg;
            }
        }

        function toggleCalendar() {
            const calSection = document.getElementById('calendarSection');
            calSection.style.display = calSection.style.display === 'none' ? 'block' : 'none';
            if (calSection.style.display === 'block') renderCalendar();
        }

        function populateHabitSelect() {
            const select = document.getElementById('habitSelect');
            select.innerHTML = '<option value="">Select a habit to view history</option>';
            habits.forEach((habit, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.textContent = (habit.emoji || 'â­') + ' ' + habit.name;
                select.appendChild(opt);
            });
        }

        function renderCalendar() {
    const select = document.getElementById('habitSelect');
    const habitIndex = select.value;
    if (habitIndex === '') {
        document.getElementById('calendar').innerHTML = '<tr><td colspan="7">Select a habit to view its calendar</td></tr>';
        return;
    }
    const habit = habits[habitIndex];
    const dates = new Set(habit.dates);

    const monthYear = document.getElementById('monthYear');
    const calTable = document.getElementById('calendar');
    
    // FIX: Use proper date object for the selected month/year
    const firstDay = new Date(currentYear, currentMonth, 1);
    monthYear.textContent = firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });

    let html = '<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr><tr>';

    const startDay = firstDay.getDay();
    for (let i = 0; i < startDay; i++) html += '<td></td>';

    // FIX: Get today's date properly in local time
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    // Loop through days of the month
    const date = new Date(currentYear, currentMonth, 1);
    while (date.getMonth() === currentMonth) {
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const isComplete = dates.has(dateStr);
        const isToday = dateStr === todayStr;
        const dayClass = isComplete ? 'day-complete' : (isToday ? 'day-today' : '');

        html += `<td class="${dayClass}">${date.getDate()}</td>`;

        if (date.getDay() === 6) html += '</tr><tr>';
        date.setDate(date.getDate() + 1);
    }

    // Fill remaining cells
    if (date.getDay() !== 0) {
        for (let i = date.getDay(); i < 7; i++) html += '<td></td>';
    }
    html += '</tr>';
    calTable.innerHTML = html;
}
        function prevMonth() {
    currentMonth--;
    if (currentMonth < 0) { 
        currentMonth = 11; 
        currentYear--; 
    }
    renderCalendar();
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) { 
        currentMonth = 0; 
        currentYear++; 
    }
    renderCalendar();
}

        function exportData() {
            const dataStr = JSON.stringify(habits, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'microhabits-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (confirm('Import will overwrite current data. Continue?')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            habits = imported;
                            habits.forEach(h => {
                                if (!h.emoji) h.emoji = suggestEmoji(h.name);
                            });
                            saveHabits();
                            alert('âœ… Backup imported successfully!');
                        } else {
                            alert('âŒ Invalid backup file.');
                        }
                    } catch (err) {
                        alert('âŒ Error reading file.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function shareStreaks() {
            if (habits.length === 0) {
                alert('No habits to share yet!');
                return;
            }
            const summary = habits.map(h => {
                const streak = calculateStreak(h.dates);
                const weekly = getWeeklyCompletions(h.dates);
                const goal = h.goal || 7;
                return `${h.emoji || 'â­'} ${h.name}: ${streak}-day streak ğŸ”¥ This week ${weekly}/${goal} ğŸ’ª`;
            }).join('\n');
            const shareText = `Building better habits worldwide! ğŸ”¥\n\n${summary}\n\nPowered by MicroHabit AI #HabitTracker2026`;
            
            if (navigator.share) {
                navigator.share({ text: shareText });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('âœ… Streaks summary copied to clipboard!\n\n' + shareText);
            }
        }

  function signUp() {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    const confirmPassword = document.getElementById('confirmPasswordInput').value;
    
    if (!email || password.length < 6) {
      document.getElementById('authStatus').textContent = 'âŒ Enter valid email and password (6+ chars)';
      return;
    }
    
    if (password !== confirmPassword) {
      document.getElementById('authStatus').textContent = 'âŒ Passwords do not match!';
      return;
    }
    
    document.getElementById('authStatus').textContent = 'Creating account...';
    document.getElementById('authStatus').style.color = 'blue';
    
    auth.createUserWithEmailAndPassword(email, password)
      .then(cred => {
        currentUser = cred.user;
        document.getElementById('authStatus').textContent = 'âœ… Account created successfully!';
        document.getElementById('authStatus').style.color = 'green';
      })
      .catch(err => {
        document.getElementById('authStatus').textContent = 'âŒ ' + err.message;
        document.getElementById('authStatus').style.color = 'red';
      });
  }

  function login() {
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    
    if (!email || !password) {
      document.getElementById('authStatus').textContent = 'âŒ Please enter email and password';
      return;
    }
    
    document.getElementById('authStatus').textContent = 'Logging in...';
    document.getElementById('authStatus').style.color = 'blue';
    
    auth.signInWithEmailAndPassword(email, password)
      .then(cred => {
        currentUser = cred.user;
        document.getElementById('authStatus').textContent = 'âœ… Login successful!';
        document.getElementById('authStatus').style.color = 'green';
      })
      .catch(err => {
        document.getElementById('authStatus').textContent = 'âŒ ' + err.message;
        document.getElementById('authStatus').style.color = 'red';
      });
  }

  function showForgotPassword() {
    const email = document.getElementById('emailInput').value.trim();
    
    if (!email) {
      document.getElementById('authStatus').textContent = 'âŒ Please enter your email first, then click Forgot Password';
      document.getElementById('authStatus').style.color = 'red';
      return;
    }
    
    if (confirm(`Send password reset email to ${email}?`)) {
      document.getElementById('authStatus').textContent = 'Sending reset email...';
      document.getElementById('authStatus').style.color = 'blue';
      
      auth.sendPasswordResetEmail(email)
        .then(() => {
          document.getElementById('authStatus').textContent = 'âœ… Password reset email sent! Check your inbox.';
          document.getElementById('authStatus').style.color = 'green';
        })
        .catch(err => {
          document.getElementById('authStatus').textContent = 'âŒ ' + err.message;
          document.getElementById('authStatus').style.color = 'red';
        });
    }
  }

  // Toggle confirm password field visibility
  document.getElementById('signupBtn').addEventListener('click', function() {
    document.getElementById('confirmPasswordInput').style.display = 'block';
  });
  
  document.getElementById('loginBtn').addEventListener('click', function() {
    document.getElementById('confirmPasswordInput').style.display = 'none';
  });

  function logout() {
    if (confirm('Logout? Your data is safe in the cloud and will reload when you login again.')) {
        auth.signOut().then(() => {
            // Clear only session data, keep onboarding flag
            const onboardingShown = localStorage.getItem('onboardingShown');
            const theme = localStorage.getItem('theme');
            const primaryColor = localStorage.getItem('primaryColor');
            
            localStorage.clear();
            
            // Restore preferences
            if (onboardingShown) localStorage.setItem('onboardingShown', onboardingShown);
            if (theme) localStorage.setItem('theme', theme);
            if (primaryColor) localStorage.setItem('primaryColor', primaryColor);
            
            // Reset variables
            habits = [];
            isPremium = false;
            currentUser = null;

            // Reload page to show login screen
            window.location.reload();
        });
    }
}

  // CRITICAL: Firebase auth state listener - this runs on page load AND when auth changes
  auth.onAuthStateChanged(async (user) => {
    if (user) {
        // User is logged in
        currentUser = user;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userEmail').textContent = 'ğŸ‘¤ ' + user.email;

        // Fetch data from Firebase
        const docSnap = await db.collection("users").doc(user.uid).get();

        if (docSnap.exists) {
            const cloudData = docSnap.data();
            
            // Load habits from cloud
            habits = cloudData.habits || [];
            
            // CRITICAL FIX: Load premium status from Firebase, not localStorage
            isPremium = cloudData.isPremium || false;
            isVIP = cloudData.isVIP || false;
            
            // Load API key if available
            if (cloudData.geminiKey) {
                localStorage.setItem('geminiKey', cloudData.geminiKey);
            }
            
            console.log(`âœ… Loaded from cloud: ${habits.length} habits, Premium: ${isPremium}`);
        } else {
            // New user - start fresh
            habits = [];
            isPremium = false;
            isVIP = false;
            console.log('ğŸ“ New user - starting fresh');
        }
        
        // Load referral code and check premium expiration
        loadReferralCode();
        checkPremiumExpiration();
    } else {
        // No user logged in
        currentUser = null;
        habits = [];
        isPremium = false;
        isVIP = false;
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
        console.log('ğŸ‘‹ No user logged in');
    }

    // Update UI
    applyTheme();
    renderHabits();
    checkPremium();
    loadApiKey();
    checkNotificationStatus();
});

        // Initialize on page load
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applyTheme);
        checkOnboarding();

        // Tab navigation function
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all nav buttons
            const navButtons = document.querySelectorAll('#navMenu button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Set active nav button
            event.target.classList.add('active');
        }

        // Support functions
        function sendSupportEmail() {
            const name = document.getElementById('supportName').value.trim();
            const email = document.getElementById('supportEmail').value.trim() || (currentUser ? currentUser.email : '');
            const category = document.getElementById('supportCategory').value;
            const message = document.getElementById('supportMessage').value.trim();
            const statusEl = document.getElementById('supportEmailStatus');
            
            if (!name || !email || !category || !message) {
                statusEl.textContent = 'âŒ Please fill in all fields';
                statusEl.style.color = 'red';
                return;
            }
            
            // Security: Sanitize all inputs
            const sanitizedName = sanitizeInput(name);
            const sanitizedMessage = sanitizeInput(message);
            
            // Security: Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                statusEl.textContent = 'âŒ Invalid email format';
                statusEl.style.color = 'red';
                return;
            }
            
            // Pre-fill user's email if logged in
            if (currentUser && !document.getElementById('supportEmail').value) {
                document.getElementById('supportEmail').value = currentUser.email;
            }
            
            // Create email body
            const subject = `[MicroHabit Support] ${category.toUpperCase()} - ${sanitizedName}`;
            const body = `Name: ${sanitizedName}\nEmail: ${email}\nUser ID: ${currentUser ? currentUser.uid : 'Not logged in'}\nPremium: ${isPremium ? 'Yes' : 'No'}\nCategory: ${category}\n\nMessage:\n${sanitizedMessage}`;
            
            // Option 1: Use mailto (opens user's email client)
            const mailtoLink = `mailto:fancytreaz@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            // Option 2: Save to Firebase for you to check later
            if (currentUser) {
                db.collection("support_tickets").add({
                    userId: currentUser.uid,
                    name: sanitizedName,
                    email: email,
                    category: category,
                    message: sanitizedMessage,
                    isPremium: isPremium,
                    timestamp: new Date().toISOString(),
                    status: 'open'
                }).then(() => {
                    statusEl.textContent = 'âœ… Message sent! We\'ll respond within 24 hours.';
                    statusEl.style.color = 'green';
                    
                    // Clear form
                    document.getElementById('supportName').value = '';
                    document.getElementById('supportMessage').value = '';
                    document.getElementById('supportCategory').value = '';
                }).catch(err => {
                    console.error('Error saving ticket:', err);
                    statusEl.textContent = 'âœ… Email client opened. Your message was prepared.';
                    statusEl.style.color = 'green';
                });
            } else {
                statusEl.textContent = 'âœ… Email client opened. Send the prepared message.';
                statusEl.style.color = 'green';
            }
        }
        
        function openLiveChat() {
            // You can integrate with Tawk.to, Intercom, Crisp, or similar
            // For now, opens WhatsApp as a "live chat" alternative
            alert('ğŸ’¬ Live Chat opening...\n\nYou\'ll be connected to our support team via WhatsApp for instant messaging!');
            openWhatsApp();
        }
        
        function openWhatsApp() {
            // Replace with your actual WhatsApp business number
            const phoneNumber = '2348108658629'; // Format: country code + number (no + or spaces)
            const message = `Hi! I need help with MicroHabit AI.\n\nUser: ${currentUser ? currentUser.email : 'Not logged in'}\nPremium: ${isPremium ? 'Yes' : 'No'}`;
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function openTwitter() {
            // Replace with your actual Twitter/X handle
            const twitterHandle = 'MicroHabitAI';
            const message = `Hi @${twitterHandle}, I need help with my account!`;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            window.open(twitterUrl, '_blank');
        }

        // Auto-fill support email when tab loads
        function loadSupportTab() {
            if (currentUser) {
                document.getElementById('supportEmail').value = currentUser.email;
            }
        }
    </script>
</body>
</html>
